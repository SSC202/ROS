# ROS2 4_åæ ‡è½¬æ¢

## 1. ä½å§¿çš„æè¿°

### åˆšä½“ä½å§¿çš„æè¿°

å¯¹äºå¹³é¢ä¸Šçš„åˆšä½“ï¼Œå¯ä»¥ä½¿ç”¨3ä¸ªå¹³åŠ¨è‡ªç”±åº¦å’Œ1ä¸ªè½¬åŠ¨è‡ªç”±åº¦æè¿°ï¼›å¯¹äºç©ºé—´ä¸­çš„åˆšä½“ï¼Œå¯ä»¥ä½¿ç”¨3ä¸ªå¹³åŠ¨è‡ªç”±åº¦å’Œ1ä¸ªè½¬åŠ¨è‡ªç”±åº¦æè¿°ã€‚

é€šå¸¸çš„ï¼Œç¡®å®šä¸€ä¸ª**ä¸–ç•Œåæ ‡ç³»**(world frameï¼Œè®°ä¸º$\{W\}$)ï¼Œå¯¹äºæœºå™¨äººä¸Šçš„åˆšä½“ï¼Œé€šå¸¸ä»¥è´¨å¿ƒä¸ºåŸç‚¹ç¡®å®šä¸€ä¸ªå›ºè¿äºåˆšä½“ä¸Šçš„**åˆšä½“åæ ‡ç³»**(body frameï¼Œè®°ä¸º$\{B\}$)ã€‚

![NULL](./assets/picture_1.jpg)

$\{W\}$å’Œ$\{B\}$ä¹‹é—´çš„å…³ç³»å³ä¸ºå¹³åŠ¨å’Œè½¬åŠ¨çš„ä½å§¿å…³ç³»ï¼Œå¹³åŠ¨ç”±åŸç‚¹å…³ç³»ç¡®å®šï¼Œè½¬åŠ¨ç”±æ—‹è½¬å…³ç³»ç¡®å®šã€‚

é€šè¿‡å„ä¸ªè‡ªç”±åº¦çš„å¾®åˆ†ï¼Œå¯ä»¥å¾—åˆ°é€Ÿåº¦å’ŒåŠ é€Ÿåº¦ä¿¡æ¯ã€‚

### å¹³åŠ¨çš„æè¿°

![NULL](./assets/picture_2.jpg)

é€šè¿‡å‘é‡$\overrightarrow{P}$æè¿°$\{B\}$çš„åŸç‚¹ç›¸å¯¹äº$\{A\}$çš„ä½ç½®$^A P_B$ï¼š
$$
\overrightarrow{P} = \left[\begin{matrix} 
p_x \\
p_y \\
p_z
\end{matrix}\right]
$$

### è½¬åŠ¨çš„æè¿°

#### æ—‹è½¬çŸ©é˜µ

- çº¿æ€§å˜æ¢

æ–¹é˜µå¯ä»¥æè¿°åŒä¸€ç»´åº¦ç©ºé—´å†…çš„çº¿æ€§å˜æ¢ã€‚

äºŒç»´ç©ºé—´ä¸­ï¼Œå‡è®¾æœ‰ä¸€ä¸ªæ–¹é˜µï¼š
$$
\left[\begin{matrix} 
a & b \\
c & d
\end{matrix}\right]
$$
å¦‚æœè¯¥æ–¹é˜µä½œç”¨äºåŸç©ºé—´ï¼Œç›¸å½“äºå°†åŸºå‘é‡$\hat{i}$è½¬æ¢ä¸º$(a,c)$ï¼Œå°†$\hat{j}$è½¬æ¢ä¸º$(b,d)$ï¼Œä»è€Œå®ç°ç©ºé—´çš„çº¿æ€§å˜æ¢ï¼Œä¹Ÿå¯è§†ä¸ºåæ ‡ç³»æ¡†æ¶è¿›è¡Œäº†å˜æ¢ã€‚

[çº¿æ€§ä»£æ•°çš„æœ¬è´¨](https://www.bilibili.com/video/BV1Ys411k7yQ/?spm_id_from=333.337.search-card.all.click&vd_source=2d2507d13250e2545de99f3c552af296)

- ä¸‰ç»´ç©ºé—´çš„æ—‹è½¬

å¯¹äºä¸‰ç»´ç©ºé—´çš„æ—‹è½¬ï¼Œå…¶çº¿æ€§å˜æ¢çŸ©é˜µä¸ºï¼š
$$
R(x,\theta) = 
\left[\begin{matrix} 
1 & 0 & 0 \\
0 & cos\theta & -sin\theta \\
0 & sin\theta & cos\theta
\end{matrix}\right] \\
R(y,\theta) = 
\left[\begin{matrix} 
cos\theta & 0 & -sin\theta \\
0 & 1 & 0 \\
sin\theta & 0 & cos\theta
\end{matrix}\right] \\
R(z,\theta) = 
\left[\begin{matrix} 
cos\theta & -sin\theta & 0 \\
sin\theta & cos\theta & 0 \\
0 & 0 & 1
\end{matrix}\right]
$$
æ—‹è½¬çŸ©é˜µæœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š

- $R$æ˜¯æ­£äº¤çŸ©é˜µï¼š$RR^T = E$ï¼›
- $|R| = 1$ï¼›
- $R$çš„æ¯ä¸€ä¸ªåˆ—å‘é‡æ€»æ˜¯å•ä½å‘é‡ï¼Œä¸”ä¸‰ä¸ªåˆ†é‡äº’ç›¸æ­£äº¤ã€‚

å› æ­¤ï¼Œ$R$ä»…æœ‰3ä¸ªè‡ªç”±åº¦ã€‚

- åæ ‡å…³ç³»

æ ¹æ®æŠ•å½±å…³ç³»ï¼Œä»»ä½•ä¸€ä¸ªå‘é‡åœ¨$\{B\}$åæ ‡ç³»åæ ‡å‡å¯ä½¿ç”¨$\{B\}$å¯¹$\{A\}$çš„æ—‹è½¬çŸ©é˜µè½¬æ¢ä¸ºåœ¨$\{A\}$åæ ‡ç³»åæ ‡ï¼š
$$
^A P = ^A _BR ^B P
$$

- æ—‹è½¬è§’åº¦

1. æ—‹è½¬çŸ©é˜µå˜æ¢æ˜¯ä¸å¯äº¤æ¢çš„ï¼ˆçŸ©é˜µä¹˜æ³•ä¸å…·æœ‰äº¤æ¢å¾‹ï¼‰ã€‚å› æ­¤éœ€è¦æ˜ç¡®æ—‹è½¬çš„å…ˆåé¡ºåºã€‚
2. æ—‹è½¬è½¬è½´æ˜¯å¯¹å›ºå®šè½¬è½´æ—‹è½¬ï¼Œè¿˜æ˜¯å¯¹å½“ä¸‹åæ ‡ç³»è½¬è½´æ—‹è½¬ã€‚

#### æ¬§æ‹‰è§’

- å›ºå®šè½¬è½´æ¬§æ‹‰è§’ï¼ˆFix angleï¼‰â€”â€”â€”â€”	X-Y-Z Fix angle

![NULL](./assets/picture_3.jpg)

$\{B\}$å¯¹$\{A\}$çš„æ—‹è½¬çŸ©é˜µä¸ºï¼š
$$
^A _BR = R(z,\alpha)R(y,\beta)R(x,\gamma) \\
= \left[\begin{matrix} 
cos\alpha cos\beta & cos\alpha sin\beta sin\gamma - sin\alpha cos\gamma & cos\alpha sin\beta cos\gamma + sin\alpha sin\gamma \\
sin\alpha cos\beta & sin\alpha sin\beta sin\gamma + cos\alpha cos\gamma & sin\alpha sin\beta cos\gamma - cos\alpha sin\gamma \\
-sin\beta & cos\beta sin\gamma & cos\beta cos\gamma
\end{matrix}\right]
$$
å›ºå®šè½¬è½´è§’æ˜¯å·¦ä¹˜æ—‹è½¬çŸ©é˜µï¼ˆç”¨çº¿æ€§å˜æ¢çš„æ–¹æ³•æ€è€ƒï¼‰ï¼›æ ¹æ®æ—‹è½¬é¡ºåºä¸åŒï¼Œå›ºå®šè½¬è½´è§’æœ‰12ç§æ—‹è½¬æ–¹å¼ã€‚

- éå›ºå®šè½¬è½´æ¬§æ‹‰è§’ï¼ˆEuler angleï¼‰â€”â€”â€”â€”	Z-Y-X Euler angle

![NULL](./assets/picture_4.jpg)

$\{B\}$å¯¹$\{A\}$çš„æ—‹è½¬çŸ©é˜µä¸ºï¼š
$$
^A _BR = ^A_{B_{,}} R ^{B_{,}}_{B_{,,}} R ^{B_{,,}}_{B_{,,,}} R \\
= \left[\begin{matrix} 
cos\alpha cos\beta & cos\alpha sin\beta sin\gamma - sin\alpha cos\gamma & cos\alpha sin\beta cos\gamma + sin\alpha sin\gamma \\
sin\alpha cos\beta & sin\alpha sin\beta sin\gamma + cos\alpha cos\gamma & sin\alpha sin\beta cos\gamma - cos\alpha sin\gamma \\
-sin\beta & cos\beta sin\gamma & cos\beta cos\gamma
\end{matrix}\right]
$$

éå›ºå®šè½¬è½´è§’æ˜¯å³ä¹˜æ—‹è½¬çŸ©é˜µï¼ˆç”¨æ—‹è½¬çš„ç›¸å¯¹æ€§æ€è€ƒï¼‰ã€‚

- æ­»é”é—®é¢˜

å¦‚æœæŒ‰ç…§ç‰¹å®šçš„é¡ºåºè¿›è¡Œæ—‹è½¬ï¼ˆå¦‚ Z-Y-X éå›ºå®šå¼ï¼‰ï¼Œå…ˆç»•è‡ªèº«Xæ—‹è½¬ä¸€å®šè§’åº¦ï¼Œå†ç»•è‡ªèº«Yæ—‹è½¬90Â°ï¼Œæ­¤æ—¶Zå’ŒXé‡åˆï¼Œæ— è®ºå¯¹Zè¿›è¡Œä½•ç§æ“ä½œï¼Œéƒ½ç¼ºå¤±ä¸€ä¸ªè‡ªç”±åº¦ï¼Œæ— æ³•æ“çºµç¬¬ä¸‰ä¸ªè½´çš„æ—‹è½¬ã€‚å¯èƒ½è€ƒè™‘çš„è§£å†³æ–¹æ³•æ˜¯å¢åŠ ä¸€æ¬¡æ—‹è½¬ï¼Œä½†æ˜¯åœ¨æ¬§æ‹‰è§’çš„é™åˆ¶ä¸‹ï¼Œè¿™æ˜¯æ— æ³•åšåˆ°çš„ã€‚

#### è½´è§’

- è½´è§’å’Œæ—‹è½¬

æœ‰ä¸€ä¸ªç»è¿‡åŸç‚¹çš„ï¼ˆå¦‚æœæ—‹è½¬è½´ä¸ç»è¿‡åŸç‚¹æˆ‘ä»¬å¯ä»¥å…ˆå°†æ—‹è½¬è½´ å¹³ç§»åˆ°åŸç‚¹ï¼Œè¿›è¡Œæ—‹è½¬ï¼Œå†å¹³ç§»å›åŸå¤„ï¼‰æ—‹è½¬è½´$\overrightarrow{u}$ï¼Œå°†ä¸€ä¸ªå‘é‡$\overrightarrow{v}$ï¼Œæ²¿ç€è¿™ä¸ªæ—‹è½¬è½´æ—‹è½¬$\theta$åº¦ï¼Œå˜æ¢åˆ°$\overrightarrow{v^,}$ã€‚

![NULL](./assets/picture_5.jpg)

ä¸ºäº†å‡å°‘è‡ªç”±åº¦ï¼Œå®šä¹‰$\overrightarrow{u}$ä¸ºå•ä½å‘é‡ã€‚

é¦–å…ˆï¼Œå°†å¯ä»¥å°†$\overrightarrow{v}$åˆ†è§£ä¸ºå¹³è¡Œäºæ—‹è½¬è½´$\overrightarrow{u}$ ä»¥åŠæ­£äº¤ï¼ˆå‚ç›´ï¼‰äº$\overrightarrow{u}$ çš„ä¸¤ä¸ªåˆ†é‡ï¼Œ$\overrightarrow{v_âˆ¥}$ å’Œ$\overrightarrow{v_âŠ¥}$ï¼Œå³ï¼š
$$
\overrightarrow{v} = \overrightarrow{v_âˆ¥} + \overrightarrow{v_âŠ¥}
$$
å¯ä»¥åˆ†åˆ«æ—‹è½¬è¿™ä¸¤ä¸ªåˆ†å‘é‡ï¼Œå†å°†å®ƒä»¬æ—‹è½¬çš„ç»“æœç›¸åŠ è·å¾—æ—‹è½¬åçš„å‘é‡ï¼š
$$
\overrightarrow{v^,} = \overrightarrow{v_âˆ¥^,} + \overrightarrow{v_âŠ¥^,}
$$
![NULL](./assets/picture_6.jpg)
$$
\overrightarrow{v_âˆ¥} = (\overrightarrow{u} \cdot \overrightarrow{v})\overrightarrow{u} \\
\overrightarrow{v_âŠ¥} = \overrightarrow{v} - (\overrightarrow{u} \cdot \overrightarrow{v})\overrightarrow{u}
$$
å¯¹äºæ—‹è½¬è€Œè¨€ï¼Œ$\overrightarrow{v_âˆ¥}$ä¸å‘ç”Ÿå˜åŒ–ï¼Œ
$$
\overrightarrow{v_âˆ¥} = \overrightarrow{v_âˆ¥^,}
$$
![NULL](./assets/picture_7.jpg)

$\overrightarrow{w}$ä¸ºé€šè¿‡å‰ä¹˜å¾—å‡ºçš„å‘é‡ï¼Œç”¨äºè¡¨è¿°$\overrightarrow{v_âŠ¥}$çš„æ—‹è½¬ï¼Œå¯ä»¥å¾—åˆ°
$$
\overrightarrow{v_âŠ¥^,} = \overrightarrow{v_v^,} + \overrightarrow{v_w^,} \\
= cos\theta \overrightarrow{v_âŠ¥} + sin\theta \overrightarrow{w} \\
= (cos\theta) \overrightarrow{v_âŠ¥} + (sin\theta) \overrightarrow{u} \times \overrightarrow{v_âŠ¥}
$$
ä¸Šè¿°ç»“æœå¯ä»¥å¾—åˆ°ï¼š
$$
\overrightarrow{v^,} = (cos\theta)\overrightarrow{v} + (1 âˆ’ cos\theta)(\overrightarrow{u} \cdot \overrightarrow{v})\overrightarrow{u} + (sin\theta) \overrightarrow{u} \times \overrightarrow{v}
$$

- è½´è§’ä¸æ—‹è½¬çŸ©é˜µ

ä»»ä½•å§¿æ€éƒ½å¯ä»¥é€šè¿‡é€‰æ‹©é€‚å½“çš„è½´å’Œè§’åº¦å¾—åˆ°ï¼Œæ¢å¥è¯è¯´ï¼Œä¸¤ä¸ªåæ ‡ç³»ä¹‹é—´çš„ä»»ä½•å§¿æ€éƒ½å¯ä»¥é€šè¿‡ç»•æŸä¸€ä¸ªç‰¹å®šçš„è½´(çŸ¢é‡)æ—‹è½¬ç‰¹å®šçš„è§’åº¦å¾—åˆ°ã€‚

é€šè¿‡ä¸Šè¿°å…¬å¼ï¼Œè½´è§’å¯¹åº”çš„æ—‹è½¬çŸ©é˜µä¸ºï¼š
$$
^P_AR = \left[\begin{matrix} 
k_xk_x(1-cos\theta)+cos\theta & k_xk_y(1-cos\theta)-k_zsin\theta & k_xk_z(1-cos\theta) + k_ysin\theta \\
k_xk_y(1-cos\theta)+k_zsin\theta & k_yk_y(1-cos\theta)+cos\theta & k_yk_z(1-cos\theta)-k_xsin\theta \\ 
k_xk_z(1-cos\theta)-k_ysin\theta & k_yk_z(1-cos\theta)+k_xsin\theta &
k_zk_z(1-cos\theta)+cos\theta

\end{matrix}\right]
$$
$K = \left[\begin{matrix} k_x & k_y & k_z \end{matrix}\right]$ä¸ºè½´å•ä½çŸ¢é‡ï¼ˆ$\{A\}$ä¸­åæ ‡ï¼‰ï¼Œ$\theta$ä¸ºæ—‹è½¬è§’åº¦ã€‚

#### å››å…ƒæ•°

[ç†è§£å››å…ƒæ•°](https://krasjet.github.io/quaternion/quaternion.pdf)

- å››å…ƒæ•°çš„å››ä¸ªæ•°å­—ç”±ä¸€ä¸ªå®éƒ¨å’Œä¸‰ä¸ªè™šéƒ¨ç»„æˆã€‚

$$
q = w + xi + yj +zk
$$
å…¶ä¸­$i^2=j^2=k^2=ijk=-1$ã€‚

å•ä½å››å…ƒæ•°æ»¡è¶³$w^2 + i^2 + j^2 + k^2 = 1$ï¼Œå³å››ç»´ç©ºé—´ä¸­çš„ä¸€ä¸ªè¶…çƒä½“ï¼Œä½†ç”±äºæœ‰ä¸Šå¼çº¦æŸï¼Œå®é™…æœ‰ä¸‰ä¸ªè‡ªç”±åº¦ã€‚

å››å…ƒæ•°ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸º$q = [s, \overrightarrow{v}]$ï¼›

> å››å…ƒæ•°çš„è¿ç®—ï¼š
>
> 1. èŒƒæ•°ï¼š$||q|| = \sqrt{s^2 + \overrightarrow{v} \cdot \overrightarrow{v}} = \sqrt{w^2 + x^2 + y^2 + z^2}$ 
> 2. åŠ æ³•ï¼š$q_1 + q_2 = [s_1 + s_2, \overrightarrow{v_1} + \overrightarrow{v_2}]$
> 3. æ•°ä¹˜ï¼š$aq = [as, a\overrightarrow{v_1}]$
> 4. ä¹˜æ³•ï¼š
>
> $$
> q_1q_2 = \left[\begin{matrix} 
> w_1 & -x_1 & -y_1 & -z_1 \\
> x_1 & w_1 & -z_1 & y_1 \\
> y_1 & z_1 & w_1 & -x_1 \\
> z_1 & -y_1 & x_1 & w_1 \\
> \end{matrix}\right]
> \left[\begin{matrix} 
> w_2 \\
> x_2 \\
> y_2 \\
> z_2
> \end{matrix}\right]
> $$
>
> å››å…ƒæ•°ä¹˜æ³•ä¸ç¬¦åˆäº¤æ¢å¾‹ã€‚
>
> ç”¨å‘é‡è¡¨ç¤ºå››å…ƒæ•°ä¹˜æ³•ï¼š
> $$
> ğ‘_1ğ‘_2 = [ğ‘ ğ‘¡ âˆ’ \overrightarrow{v} \cdot \overrightarrow{u}, ğ‘ \overrightarrow{u} + ğ‘¡\overrightarrow{v} + \overrightarrow{v} \times \overrightarrow{u}]
> $$

- å››å…ƒæ•°å’Œæ—‹è½¬

ä¸¤ä¸ªçº¯å››å…ƒæ•°ä¹˜æ³•å…¬å¼å¦‚ä¸‹ï¼š
$$
ğ‘_1ğ‘_2 = [-\overrightarrow{v} \cdot \overrightarrow{u}, \overrightarrow{v} \times \overrightarrow{u}]
$$
è®¨è®º$\overrightarrow{v_âŠ¥}$ï¼›ç”±äº$\overrightarrow{v_âŠ¥^,} = (cos\theta) \overrightarrow{v_âŠ¥} + (sin\theta) \overrightarrow{u} \times \overrightarrow{v_âŠ¥}$ï¼Œä¸”$\overrightarrow{u} \cdot \overrightarrow{v_âŠ¥} = 0$ï¼Œåˆ™ç”¨çº¯å››å…ƒæ•°è¡¨è¿°ä¸ºï¼š
$$
v_âŠ¥^, = (cos\theta) v_âŠ¥ + (sin\theta) u v_âŠ¥ \\
= ( cos\theta + sin\theta u )v_âŠ¥
$$
ä»¤$q = cos\theta + sin\theta u$ï¼Œåˆ™å˜æ¢å¦‚ä¸‹ï¼š
$$
q = cos\theta + sin\theta u \\
= [cos\theta,sin\theta \overrightarrow{u}]
$$
$q$äº¦ä¸ºå•ä½å››å…ƒæ•°ã€‚

æ•…æ—‹è½¬å¯ä»¥è¡¨ç¤ºä¸ºï¼š
$$
v^, = v_{||} + qv_{âŠ¥}
$$
ç»è¿‡ä¸€ç³»åˆ—å˜æ¢æ¶ˆå»åˆ†é‡ï¼ˆä¸åŠ è¯æ˜ï¼‰ï¼Œå¯å¾—ï¼š
$$
v^, = qvq^{-1} \\
q = [cos(\frac{1}{2}\theta),sin(\frac{1}{2}\theta)\overrightarrow{u}]
$$
è¡¨ç¤ºä¸ºæ—‹è½¬ju'zhen
$$
^A_PR = \left[\begin{matrix} 
1-2y^2-2z^2 & 2(xy-zw) & 2(xz+yw) \\
2(xy+zw) & 1-2x^2-2z^2 &  2(yz-xw) \\ 
2(xz-yw) & 2(yz+xw) & 1-2x^2-2y^2
\end{matrix}\right]
$$

### ä»£ç å®ç°å§¿æ€è¡¨ç¤ºæ–¹æ³•çš„è½¬æ¢

```python
import transforms3d as tfs

# å››å…ƒè§’æ¨¡å— quaternions
# æ¬§æ‹‰è§’æ¨¡å— euler
# è½´è§’æ¨¡å— axangles
```

### é½æ¬¡å˜æ¢çŸ©é˜µ

$$
T = \left[\begin{matrix} 
^P_AR & ^P_AP \\ 
0 & 1

\end{matrix}\right]
$$

ä¸ºé½æ¬¡å˜æ¢çŸ©é˜µï¼Œæ­¤æ—¶ï¼Œæ—‹è½¬çŸ©é˜µå’Œå¹³ç§»å˜æ¢å¯åˆå¹¶ä¸ºé½æ¬¡å˜æ¢çŸ©é˜µã€‚

çŸ©é˜µçš„**å·¦ä¸Šè§’æ ‡æ˜å‚è€ƒåæ ‡ç³»**ï¼ŒçŸ©é˜µ**å·¦ä¸‹è§’æ ‡æ˜ç›®æ ‡åæ ‡ç³»**ã€‚æ¯”å¦‚$^A_BT$è¡¨ç¤ºBåæ ‡ç³»åˆ°Aåæ ‡ç³»çš„å˜æ¢å…³ç³»ã€‚

é½æ¬¡å˜æ¢çŸ©é˜µæ˜¯å¯é€†çš„ï¼Œ$^A_BT^{-1} = ^B_AT$ã€‚

> - é½æ¬¡çŸ©é˜µä¸å¹³ç§»å‘é‡ç›¸ä¹˜ï¼Œå³å¯æ±‚å‡ºæŸä¸ªå‘é‡åœ¨å¦ä¸€åæ ‡ç³»ä¸‹çš„è¡¨ç¤ºã€‚
> - é½æ¬¡çŸ©é˜µä¸é½æ¬¡çŸ©é˜µç›¸ä¹˜ï¼Œå¯ä»¥è½¬æ¢ä¸åŒåæ ‡ç³»ä¹‹é—´çš„å…³ç³»ã€‚

```python
tfs.affines.compose(T,R,[1,1,1]) # åˆæˆé½æ¬¡å˜æ¢çŸ©é˜µ

tfs.euler.mat2euler(T[0:3,0:3]),T[:3,3:4] # åˆ†è§£ä¸ºå›ºå®šè½´æ¬§æ‹‰è§’å’Œå¹³ç§»å‘é‡
tfs.quaternions.mat2quat(T[0:3,0:3]),T[:3,3:4] #  åˆ†è§£ä¸ºå››å…ƒæ•°å’Œå¹³ç§»å‘é‡
```

## 2. ROS2 TFåæ ‡å˜æ¢

### TF2 çš„ CLI å‘½ä»¤

```shell
# x y z å¹³ç§»çŸ©é˜µï¼Œframe_id çˆ¶åæ ‡ç³»ï¼ˆå‚è€ƒåæ ‡ç³»ï¼‰ child_frame_id å­åæ ‡ç³»ï¼ˆç›®æ ‡åæ ‡ç³»ï¼‰

# é™æ€åæ ‡å¹¿æ’­ï¼ˆå››å…ƒæ•°æ–¹å¼ï¼‰
ros2 run tf2_ros static_transform_publisher x y z qx qy qz qw frame_id child_frame_id
# é™æ€åæ ‡å¹¿æ’­ï¼ˆæ¬§æ‹‰è§’æ–¹å¼ï¼‰
ros2 run tf2_ros static_transform_publisher x y z yaw pitch roll frame_id child_frame_id 

# ç›‘å¬åæ ‡å…³ç³»
ros2 run tf2_ros tf2_echo frame_id child_frame_id 

# æŸ¥æ‰¾æ‰€æœ‰å‘å¸ƒè€…å’Œå‘å¸ƒé¢‘ç‡
ros2 run tf2_ros tf2_monitor 
```

### å¹¿æ’­å‘å¸ƒå™¨å®ç°

> 1. ä½¿ç”¨`StaticTransformBroadcaster()`å‡½æ•°æ„å»ºåæ ‡å¹¿æ’­å™¨ï¼›
> 2. ä½¿ç”¨`TransformStamped()`å®ä¾‹åŒ–TFå¸§ï¼›
> 3. ç¼–å†™TFå¸§ï¼š
>
> > 1. `header.stamp`ï¼šTFæ—¶é—´ï¼›
> > 2. `header.frame_id`ï¼šçˆ¶åæ ‡ç³»ï¼›
> > 3. `child_frame_id`ï¼šå­åæ ‡ç³»ï¼›
> > 4. `transform.translation`ï¼šå¹³ç§»åæ ‡ï¼›
> > 5. `transform.rotation`ï¼šæ—‹è½¬ï¼Œå››å…ƒæ•°è¡¨ç¤ºã€‚
>
> 4. ä½¿ç”¨`sendTransform()`æ–¹æ³•å‘å¸ƒTFå¸§ã€‚

```python
import rclpy 
from rclpy.node import Node
# å¯¼å…¥TFå¸§
from geometry_msgs.msg import TransformStamped
# å¯¼å…¥TFé™æ€åæ ‡å‘å¸ƒå™¨
from tf2_ros import StaticTransformBroadcaster
import transforms3d as tfs
import numpy as np

class TF_StaticBroadcaster_Node(Node):
    def __init__(self,name):
        global pitch_degree
        super().__init__(name)
        pitch_degree = 0.0
        # æ„é€ é™æ€åæ ‡å¹¿æ’­å‘å¸ƒå™¨
        self.tf_publisher = StaticTransformBroadcaster(self)
        self.tf_timer = self.create_timer(1.0,self.timer_callback)

    def timer_callback(self):
        global pitch_degree
        # æ„é€ TFå¸§
        tf_frame = TransformStamped()
        tf_frame.header.stamp = self.get_clock().now().to_msg()
        ## çˆ¶åæ ‡ç³»
        tf_frame.header.frame_id = "base"
        ## å­åæ ‡ç³»
        tf_frame.child_frame_id = "camera"
        ## åæ ‡å˜æ¢æ•°æ®
        tf_frame.transform.translation.x = 2.0
        tf_frame.transform.translation.y = 5.0
        tf_frame.transform.translation.z = 4.0

        pitch_degree = pitch_degree + 1.0

        pitch = float(pitch_degree * (np.pi) / 180)
        roll = float(5 * (np.pi) / 180)
        yaw = float(35 * (np.pi) / 180)

        ## è½¬æ¢ä¸ºå››å…ƒæ•°
        q = tfs.euler.euler2quat(pitch,roll,yaw,"sxyz")
        w = q[0]
        x = q[1]
        y = q[2]
        z = q[3]
        tf_frame.transform.rotation.w = w
        tf_frame.transform.rotation.y = y
        tf_frame.transform.rotation.z = z
        tf_frame.transform.rotation.x = x

        self.tf_publisher.sendTransform(tf_frame)


def main(args=None):
    rclpy.init(args=args)
    node = TF_StaticBroadcaster_Node("TF_StaticBroadcaster_Node")
    rclpy.spin(node)
    rclpy.shutdown()
```

### å¹¿æ’­ç›‘å¬å™¨å®ç°

> 1. `Buffer()`å‡½æ•°åˆ›å»ºæ•°æ®ç¼“å†²åŒºï¼›
> 2. `TransformListener()`å‡½æ•°å»ºç«‹å¹¿æ’­ç›‘å¬å™¨ï¼›
>
> ```python
> """
> 	å¹¿æ’­ç›‘å¬å™¨åˆ›å»ºå‡½æ•°ï¼š
> 	ç¬¬ä¸€ä¸ªå‚æ•°ï¼šæ•°æ®ç¼“å†²åŒº
> 	ç¬¬äºŒä¸ªå‚æ•°ï¼šèŠ‚ç‚¹
> """
> TransformListener()
> ```
>
> 3. ä½¿ç”¨`rclpy`çš„æ—¶é—´åˆ›å»ºæ—¶é—´æ•°æ®ã€‚
> 4. ä½¿ç”¨æ•°æ®ç¼“å†²åŒºçš„`lookup_transform()`æ–¹æ³•æ¥æ”¶åæ ‡å˜æ¢æ•°æ®ã€‚
>
> ```python
> """
> 	åæ ‡å˜æ¢æ•°æ®æ¥æ”¶å‡½æ•°
> 	ç¬¬ä¸€ä¸ªå‚æ•°ï¼šçˆ¶åæ ‡ç³»
> 	ç¬¬äºŒä¸ªå‚æ•°ï¼šå­åæ ‡ç³»
> 	ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šæ—¶é—´
> """
> lookup_transform()
> ```
>
> 5. åˆ¤åˆ«å¼‚å¸¸å¹¶æ‰“å°æ—¥å¿—ã€‚

```python
import rclpy
from rclpy.node import Node
# å¯¼å…¥åæ ‡å˜æ¢ç›‘å¬å™¨
from tf2_ros import TransformException
from tf2_ros.buffer import Buffer
from tf2_ros.transform_listener import TransformListener

class TF_Listener_Node(Node):
    def __init__(self,name):
        super().__init__(name)
        # åˆ›å»ºç¼“å†²åŒºå’Œç›‘å¬å™¨
        self.tf_buffer = Buffer()
        self.tf_listener = TransformListener(self.tf_buffer,self)
        self.timer = self.create_timer(1.0,self.timer_callback)
    
    def timer_callback(self):
        try:
            now = rclpy.time.Time()
            trans = self.tf_buffer.lookup_transform('base','camera',now)
            print(trans)
        except TransformException as ex:
            print(f'Not found transform:{ex}')



def main(args=None):
    rclpy.init(args=args)
    node = TF_Listener_Node('TF_Listerner')
    rclpy.spin(node)
    rclpy.shutdown()
```



