# Ubuntu 关于串口的问题

## 0. 串口指令

- 查看串口号

```shell
$ ls /dev			# 查看所有设备号
$ ls /dev/tty*		# 查看前缀为tty的设备号
```

## 1. 串口权限

通常的，如果没有设置串口权限，访问串口时会报出 `no permittion` 之类的无访问权限错误。

<font color=LightGreen>1. 临时修改串口权限</font>

```shell
$ sudo chmod 666 /dev/ttyUSB0
```

> 使用此方法，每次重新插拔串口设备，或者重新启动电脑都要重新更改权限，很不方便。

<font color=LightGreen>2. 添加权限规则</font>

- 创建规则文件

```shell
$ sudo gedit /etc/udev/rules.d/70-ttyusb.rules
```

- 规则文件中添加以下内容

```
KERNEL=="ttyUSB[0-9]*", MODE="0666"
```

- 重启系统

<font color=LightGreen>3. 添加用户组</font>

将该用户添加至`dialout`用户组，因为`tty`设备是属于`dialout`用户组，所以将用户添加到`dialout`用户组，该用户就具备了访问`tty`设备的权限。

- 查看串口信息

```shell
$ ls -l /dev/ttyUSB0
crw-rw---- 1 root dialout 4, 64 Jun  2 18:39 /dev/ttyUSB0
```

- 查看当前用户名

```shell
$ whoami
```

- 当前用户加入到`dialout`用户组

```shell
sudo usermod -aG dialout <username>
```

- 重启系统

## 2. 串口重映射

用 Ubuntu 系统来做硬件控制的时候，常使用USB串口与传感器或者驱动器进行信息通信。 Ubuntu 系统在开机的时候会为每一个插入的USB设备自动升序命名，如`ttyUSB0`、`ttyUSB1`......（有些也会命名为`ttyACM0`、`ttyACM1`......），而程序运行时也就直接和这些设备名进行读写操作。

但是这里存在一个问题，每次开机后，USB设备名都有可能发生窜动，比如上一次开机这个设备被命名为`ttyUSB0`，这次开机却被命名为`ttyUSB3`，因此不得不回到程序里把串口名更改，并重新编译，费时费力。

当然，也有办法解决这个问题，就是把每一个USB设备都取一个别名，之后在程序里就不再呼唤系统自动命名的设备名，而是直接与自定义的别名交互。

<font color=LightGreen>1. 绑定软件设备号，即`idVendor`和`idProduct`（适用于不同生产商生产的不同USB串口）</font>

- 查看 USB 串口 ID

```shell
$ lsusb
```

- 查看的 ID 为 xxxx:xxxx ，前四位数为`idVendor`（生产商ID），后四位数为`idProduct`（设备ID）
- 添加规则文件

```shell
$ sudo gedit /etc/udev/rules.d/myusb.rule  
```

添加以下内容：

```
KERNEL=="ttyUSB*", ATTRS{idVendor}=="0403", ATTRS{idProduct}=="6001", MODE:="0777", SYMLINK+="myusb"
```

- 现在可以使用`dev/myusb`打开串口。

<font color=LightGreen>2. 绑定硬件序列号，查找serial（适用于相同生产商生产的相同USB串口）</font>

## 3. 串口驱动

### CH340 驱动

[CH341SER_Linux驱动](https://www.wch.cn/downloads/CH341SER_LINUX_ZIP.html)

Ubuntu 自带的 CH340 驱动通常版本十分古老，需要用户自行编译安装，十分的麻烦。

解压后存在`ch34x.c`，`Makefile`两个文件。

- 卸载旧版驱动

```shell
# 查看内核版本
$ uname -r

# 查看系统自带驱动
$ ls /lib/modules/$(uname -r)/kernel/drivers/usb/serial

# 查看串口设备信息
$ sudo dmesg | grep tty

# 如果brltty占用了串口就把他卸载掉，不会影响使用
$ sudo apt remove brltty

#进入串口驱动目录，用管理员权限删除ch34开头那个驱动文件
$ cd /lib/modules/$(uname -r)/kernel/drivers/usb/serial
$ sudo rm ch341.ko
```

- 首先到[此链接](https://elixir.bootlin.com/linux/v5.19/source/drivers/usb/serial/ch341.c)选择匹配的内核版本，然后把右边的代码全部拷贝出来替换掉第一步解压出来的`ch34x.c`，删除新建一个同名c文件也可以。然后编译，期间可能提示编译器不匹配，不影响使用。

```shell
# 编译
$ make
# 加载，但这样下次重启驱动后需要重新加载
$ make load
# 或者这样加载，也是重启后失效
$ sudo insmod ch34x.ko
```

- 用管理员权限把编译出来的`ch34x.ko`文件拷贝回原驱动目录，然后修改模块名到之前的旧驱动名称。

```shell
# 驱动文件拷贝回驱动目录
$ sudo cp ch34x.ko /lib/modules/$(uname -r)/kernel/drivers/usb/serial
$ cd /lib/modules/$(uname -r)/kernel/drivers/usb/serial
$ sudo mv ch34x.ko ch341.ko
```

- 重启，CH340也可以自动加载了
